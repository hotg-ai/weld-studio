<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Provides function multiversioning."><meta name="keywords" content="rust, rustlang, rust-lang, multiversion"><title>multiversion in multiversion - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc attr"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../multiversion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../multiversion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><div class="sidebar-elems"><h2 class="location"><a href="index.html">In multiversion</a></h2><div id="sidebar-vars" data-name="multiversion" data-ty="attr" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../multiversion/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Attribute Macro <a href="index.html">multiversion</a>::<wbr><a class="attr" href="#">multiversion</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/multiversion_macros/lib.rs.html#19-22">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><div class="docblock item-decl"><pre class="rust attr"><code>#[multiversion]</code></pre></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Provides function multiversioning.</p>
<p>Functions are selected in order, calling the first matching target.  The function tagged by the
attribute is the generic implementation that does not require any specific architecture or
features.</p>
<h2 id="helper-attributes"><a href="#helper-attributes">Helper attributes</a></h2>
<ul>
<li><code>#[clone]</code>
<ul>
<li>Clones the function for the specified target.</li>
<li>Arguments:
<ul>
<li><code>target</code>: the target specification of the clone</li>
</ul>
</li>
</ul>
</li>
<li><code>#[specialize]</code>
<ul>
<li>Specializes the function for the specified target with another function.</li>
<li>Arguments:
<ul>
<li><code>target</code>: the target specification of the specialization</li>
<li><code>fn</code>: path to the function specializing the tagged function</li>
<li><code>unsafe</code> (optional): indicates whether the specialization function is <code>unsafe</code>, but safe to
call for this target.
Functions tagged with the <a href="attr.target.html"><code>target</code></a> attribute must be <code>unsafe</code>, so marking <code>unsafe = true</code>
indicates that the safety contract is fulfilled and<code>function</code> is safe to call on the specified
target.  If <code>function</code> is unsafe for any other reason, remember to mark the tagged function
<code>unsafe</code> as well.</li>
</ul>
</li>
</ul>
</li>
<li><code>#[crate_path]</code>
<ul>
<li>Specifies the location of the multiversion crate (useful for re-exporting).</li>
<li>Arguments:
<ul>
<li><code>path</code>: the path to the multiversion crate</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="examples"><a href="#examples">Examples</a></h2><h3 id="cloning"><a href="#cloning">Cloning</a></h3>
<p>The following compiles <code>square</code> three times, once for each target and once for the generic
target.  Calling <code>square</code> selects the appropriate version at runtime.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion::multiversion</span>;

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">square</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>
    }
}</code></pre></div>
<h3 id="specialization"><a href="#specialization">Specialization</a></h3>
<p>This example creates a function <code>where_am_i</code> that prints the detected CPU feature.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion::multiversion</span>;

<span class="kw">fn</span> <span class="ident">where_am_i_avx</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;avx&quot;</span>);
}

<span class="kw">fn</span> <span class="ident">where_am_i_sse</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;sse&quot;</span>);
}

<span class="kw">fn</span> <span class="ident">where_am_i_neon</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;neon&quot;</span>);
}

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>, <span class="kw">fn</span>  <span class="op">=</span> <span class="string">&quot;where_am_i_avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;where_am_i_sse&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[arm|aarch64]+neon&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;where_am_i_neon&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">where_am_i</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;generic&quot;</span>);
}
</code></pre></div>
<h3 id="making-target_feature-functions-safe"><a href="#making-target_feature-functions-safe">Making <code>target_feature</code> functions safe</a></h3>
<p>This example is the same as the above example, but calls <code>unsafe</code> specialized functions.  Note
that the <code>where_am_i</code> function is still safe, since we know we are only calling specialized
functions on supported CPUs.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion</span>::{<span class="ident">multiversion</span>, <span class="ident">target</span>};

<span class="attribute">#[<span class="ident">target</span>(<span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">where_am_i_avx</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;avx&quot;</span>);
}

<span class="attribute">#[<span class="ident">target</span>(<span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">where_am_i_sse</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;sse&quot;</span>);
}

<span class="attribute">#[<span class="ident">target</span>(<span class="string">&quot;[arm|aarch64]+neon&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">where_am_i_neon</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;neon&quot;</span>);
}

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;where_am_i_avx&quot;</span>, <span class="kw">unsafe</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;where_am_i_sse&quot;</span>, <span class="kw">unsafe</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[arm|aarch64]+neon&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;where_am_i_neon&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">where_am_i</span>() {
    <span class="macro">println!</span>(<span class="string">&quot;generic&quot;</span>);
}
</code></pre></div>
<h2 id="static-dispatching"><a href="#static-dispatching">Static dispatching</a></h2>
<p>The <a href="attr.multiversion.html"><code>multiversion</code></a> attribute allows functions called inside the function to be statically dispatched.
Additionally, functions created with this attribute can themselves be statically dispatched.
See <a href="index.html#static-dispatching">static dispatching</a> for more information.</p>
<h2 id="conditional-compilation"><a href="#conditional-compilation">Conditional compilation</a></h2>
<p>The <a href="attr.multiversion.html"><code>multiversion</code></a> attribute supports conditional compilation with the <code>#[target_cfg]</code> helper
attribute. See <a href="index.html#conditional-compilation">conditional compilation</a> for more information.</p>
<h2 id="function-name-mangling"><a href="#function-name-mangling">Function name mangling</a></h2>
<p>The functions created by this macro are mangled as <code>{ident}_{features}_version</code>, where <code>ident</code> is
the name of the multiversioned function, and <code>features</code> is either <code>default</code> (for the default
version with no features enabled) or the list of features, sorted alphabetically.  Dots (<code>.</code>)
in the feature names are removed.</p>
<p>The following creates two functions, <code>foo_avx_sse41_version</code> and <code>foo_default_version</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attribute">#[<span class="ident">multiversion::multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+sse4.1+avx&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">foo</span>() {}

<span class="attribute">#[<span class="ident">multiversion::target</span>(<span class="string">&quot;[x86|x86_64]+sse4.1+avx&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">call_foo_avx</span>() {
    <span class="ident">foo_avx_sse41_version</span>();
}

<span class="kw">fn</span> <span class="ident">call_foo_default</span>() {
    <span class="ident">foo_default_version</span>();
}</code></pre></div>
<h2 id="implementation-details"><a href="#implementation-details">Implementation details</a></h2>
<p>The function version dispatcher consists of a function selector and an atomic function pointer.
Initially the function pointer will point to the function selector. On invocation, this selector
will then choose an implementation, store a pointer to it in the atomic function pointer for later
use and then pass on control to the chosen function. On subsequent calls, the chosen function
will be called without invoking the function selector.</p>
<p>Some comments on the benefits of this implementation:</p>
<ul>
<li>The function selector is only invoked once. Subsequent calls are reduced to an atomic load
and indirect function call (for non-generic, non-<code>async</code> functions). Generic and <code>async</code> functions
cannot be stored in the atomic function pointer, which may result in additional branches.</li>
<li>If called in multiple threads, there is no contention. It is possible for two threads to hit
the same function before function selection has completed, which results in each thread
invoking the function selector, but the atomic ensures that these are synchronized correctly.</li>
</ul>
</div></details></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="multiversion" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.0 (a8314ef7d 2022-06-27)" ></div>
</body></html>