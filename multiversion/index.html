<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This crate provides the `target`  and `multiversion` attributes for implementing function multiversioning."><meta name="keywords" content="rust, rustlang, rust-lang, multiversion"><title>multiversion - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../multiversion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../multiversion/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Crate multiversion</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.6.1</li><li><a id="all-types" href="all.html">All Items</a></li></div></ul><section><div class="block"><ul><li><a href="#macros">Macros</a></li><li><a href="#attributes">Attribute Macros</a></li></ul></div></section><div id="sidebar-vars" data-name="multiversion" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../multiversion/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">multiversion</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/multiversion/lib.rs.html#1-425">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This crate provides the <a href="attr.target.html"><code>target</code></a>  and <a href="attr.multiversion.html"><code>multiversion</code></a> attributes for implementing
function multiversioning.</p>
<p>Many CPU architectures have a variety of instruction set extensions that provide additional
functionality. Common examples are single instruction, multiple data (SIMD) extensions such as
SSE and AVX on x86/x86-64 and NEON on ARM/AArch64. When available, these extended features can
provide significant speed improvements to some functions. These optional features cannot be
haphazardly compiled into programs–executing an unsupported instruction will result in a
crash.</p>
<p><strong>Function multiversioning</strong> is the practice of compiling multiple versions of a function
with various features enabled and safely detecting which version to use at runtime.</p>
<h2 id="cargo-features"><a href="#cargo-features">Cargo features</a></h2>
<p>There is one cargo feature, <code>std</code>, enabled by default.  When enabled, <a href="attr.multiversion.html"><code>multiversion</code></a> will
use CPU feature detection at runtime to dispatch the appropriate function. Disabling this
feature will only allow compile-time function dispatch using <code>#[cfg(target_feature)]</code> and can
be used in <code>#[no_std]</code> crates.</p>
<h2 id="capabilities"><a href="#capabilities">Capabilities</a></h2>
<p>The intention of this crate is to allow any function, other than trait methods, to be
multiversioned.  If any functions do not work please file an issue on GitHub.</p>
<p>The <a href="attr.multiversion.html"><code>multiversion</code></a> macro produces additional functions adjacent to the tagged function which
do not correspond to a trait member.  If you would like to multiversion a trait method, instead
try multiversioning a free function or struct method and calling it from the trait method.</p>
<h2 id="target-specification-strings"><a href="#target-specification-strings">Target specification strings</a></h2>
<p>Targets for the <a href="attr.target.html"><code>target</code></a> and <a href="attr.multiversion.html"><code>multiversion</code></a> attributes are specified as a combination of
architecture (as specified in the <a href="https://doc.rust-lang.org/reference/conditional-compilation.html#target_arch"><code>target_arch</code></a> attribute) and feature (as specified in the
<a href="https://doc.rust-lang.org/reference/conditional-compilation.html#target_feature"><code>target_feature</code></a> attribute). A single architecture can be specified as:</p>
<ul>
<li><code>&quot;arch&quot;</code></li>
<li><code>&quot;arch+feature&quot;</code></li>
<li><code>&quot;arch+feature1+feature2&quot;</code></li>
</ul>
<p>while multiple architectures can be specified as:</p>
<ul>
<li><code>&quot;[arch1|arch2]&quot;</code></li>
<li><code>&quot;[arch1|arch2]+feature&quot;</code></li>
<li><code>&quot;[arch1|arch2]+feature1+feature2&quot;</code></li>
</ul>
<p>The following are all valid target specification strings:</p>
<ul>
<li><code>&quot;x86&quot;</code> (matches the <code>&quot;x86&quot;</code> architecture)</li>
<li><code>&quot;x86_64+avx+avx2&quot;</code> (matches the <code>&quot;x86_64&quot;</code> architecture with the <code>&quot;avx&quot;</code> and <code>&quot;avx2&quot;</code>
features)</li>
<li><code>&quot;[mips|mips64|powerpc|powerpc64]&quot;</code> (matches any of the <code>&quot;mips&quot;</code>, <code>&quot;mips64&quot;</code>, <code>&quot;powerpc&quot;</code> or
<code>&quot;powerpc64&quot;</code> architectures)</li>
<li><code>&quot;[arm|aarch64]+neon&quot;</code> (matches either the <code>&quot;arm&quot;</code> or <code>&quot;aarch64&quot;</code> architectures with the
<code>&quot;neon&quot;</code> feature)</li>
</ul>
<h2 id="example"><a href="#example">Example</a></h2>
<p>The following example is a good candidate for optimization with SIMD.  The function <code>square</code>
optionally uses the AVX instruction set extension on x86 or x86-64.  The SSE instruction set
extension is part of x86-64, but is optional on x86 so the square function optionally detects
that as well.  This is automatically implemented by the <a href="attr.multiversion.html"><code>multiversion</code></a> attribute.</p>
<p>The following works by compiling multiple <em>clones</em> of the function with various features enabled
and detecting which to use at runtime. If none of the targets match the current CPU (e.g. an older
x86-64 CPU, or another architecture such as ARM), a clone without any features enabled is used.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion::multiversion</span>;

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">square</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>;
    }
}</code></pre></div>
<p>The following produces a nearly identical function, but instead of cloning the function, the
implementations are manually specified. This is typically more useful when the implementations
aren’t identical, such as when using explicit SIMD instructions instead of relying on compiler
optimizations.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion</span>::{<span class="ident">multiversion</span>, <span class="ident">target</span>};

<span class="attribute">#[<span class="ident">target</span>(<span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">square_avx</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>;
    }
}

<span class="attribute">#[<span class="ident">target</span>(<span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">square_sse</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>;
    }
}

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;square_avx&quot;</span>, <span class="kw">unsafe</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="attribute">#[<span class="ident">specialize</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>, <span class="kw">fn</span> <span class="op">=</span> <span class="string">&quot;square_sse&quot;</span>, <span class="kw">unsafe</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="kw">fn</span> <span class="ident">square</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>;
    }
}
</code></pre></div>
<h2 id="static-dispatching"><a href="#static-dispatching">Static dispatching</a></h2>
<p>Sometimes it may be useful to call multiversioned functions from other multiversioned functions.
In these situations it would be inefficient to perform feature detection multiple times.
Additionally, the runtime detection prevents the function from being inlined.  In this situation,
the <code>dispatch</code> helper macro allows bypassing feature detection:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">multiversion::multiversion</span>;

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">square</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="kw-2">*</span><span class="op">=</span> <span class="kw-2">*</span><span class="ident">v</span>
    }
}

<span class="attribute">#[<span class="ident">multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;x86+sse&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">square_plus_one</span>(<span class="ident">x</span>: <span class="kw-2">&amp;mut</span> [<span class="ident">f32</span>]) {
    <span class="macro">dispatch!</span>(<span class="ident">square</span>(<span class="ident">x</span>)); <span class="comment">// this function call bypasses feature detection</span>
    <span class="kw">for</span> <span class="ident">v</span> <span class="kw">in</span> <span class="ident">x</span> {
        <span class="kw-2">*</span><span class="ident">v</span> <span class="op">+</span><span class="op">=</span> <span class="number">1.0</span>;
    }
}
</code></pre></div>
<p>The <code>dispatch</code> macro supports either paths or function calls:</p>
<ul>
<li><code>dispatch!(foo)</code></li>
<li><code>dispatch!(Self::foo::&lt;A, B&gt;)</code></li>
<li><code>dispatch!(foo(a, b))</code></li>
<li><code>dispatch!(self.foo::&lt;A, B&gt;(a, b))</code></li>
</ul>
<p>The statically dispatched function must be multiversioned over a subset of CPU features
supported by the caller function.  For example, a function compiled for <code>x86_64+avx+avx2</code>
cannot statically dispatch a function compiled for <code>x86_64+avx</code>, but a function compiled
for <code>x86_64+avx</code> may statically dispatch a multiversioned function compiled for both
<code>[x86|x86_64]+avx</code> and <code>x86+sse</code> since an exact feature match exists for that architecture.</p>
<h2 id="conditional-compilation"><a href="#conditional-compilation">Conditional compilation</a></h2>
<p>The <code>#[cfg]</code> attribute allows conditional compilation based on the target architecture and
features, however this does not take into account additional features specified by
<code>#[target_feature]</code>.  In this scenario, the <code>#[target_cfg]</code> helper attribute provides
conditional compilation in functions tagged with <a href="attr.multiversion.html"><code>multiversion</code></a> or <a href="attr.target.html"><code>target</code></a>.</p>
<p>The <code>#[target_cfg]</code> attribute supports <code>all</code>, <code>any</code>, and <code>not</code> (just like <code>#[cfg]</code>) and
supports the following keys:</p>
<ul>
<li><code>target</code>: takes a target specification string as a value and is true if the target matches
the function’s target</li>
</ul>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attribute">#[<span class="ident">multiversion::multiversion</span>]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
<span class="attribute">#[<span class="ident">clone</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[arm|aarch64]+neon&quot;</span>)]</span>
<span class="kw">fn</span> <span class="ident">print_arch</span>() {
    <span class="attribute">#[<span class="ident">target_cfg</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>)]</span>
    <span class="macro">println!</span>(<span class="string">&quot;avx&quot;</span>);

    <span class="attribute">#[<span class="ident">target_cfg</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[arm|aarch64]+neon&quot;</span>)]</span>
    <span class="macro">println!</span>(<span class="string">&quot;neon&quot;</span>);

    <span class="attribute">#[<span class="ident">target_cfg</span>(<span class="ident">not</span>(<span class="ident">any</span>(<span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[x86|x86_64]+avx&quot;</span>, <span class="ident">target</span> <span class="op">=</span> <span class="string">&quot;[arm|aarch64]+neon&quot;</span>)))]</span>
    <span class="macro">println!</span>(<span class="string">&quot;generic&quot;</span>);
}</code></pre></div>
</div></details><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.are_cpu_features_detected.html" title="multiversion::are_cpu_features_detected macro">are_cpu_features_detected</a></div><div class="item-right docblock-short"><p>Detects CPU features.</p>
</div></div></div><h2 id="attributes" class="small-section-header"><a href="#attributes">Attribute Macros</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.multiversion.html" title="multiversion::multiversion attr">multiversion</a></div><div class="item-right docblock-short"><p>Provides function multiversioning.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.target.html" title="multiversion::target attr">target</a></div><div class="item-right docblock-short"><p>Provides a less verbose equivalent to the <code>target_arch</code> and <code>target_feature</code> attributes.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="multiversion" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.0 (a8314ef7d 2022-06-27)" ></div>
</body></html>